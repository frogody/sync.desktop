name: Build macOS

on:
  # Allow manual triggering
  workflow_dispatch:

  # Trigger on release published
  release:
    types: [published]

jobs:
  build-macos:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      # Optional: Prepare Apple API Key for signing/notarization
      # This step only runs if the secret is present
      - name: Prepare Apple API Key
        if: ${{ secrets.APPLE_API_KEY_PRIVATE_BASE64 != '' }}
        run: |
          echo "Decoding Apple API Key..."
          echo "${{ secrets.APPLE_API_KEY_PRIVATE_BASE64 }}" | base64 --decode > /tmp/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          echo "Apple API Key prepared at /tmp/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8"
        env:
          APPLE_API_KEY_PRIVATE_BASE64: ${{ secrets.APPLE_API_KEY_PRIVATE_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}

      # Optional: Code signing and notarization
      # These environment variables are only set if the secrets exist
      - name: Package for macOS (with signing)
        if: ${{ secrets.APPLE_ID != '' && secrets.APPLE_APP_SPECIFIC_PASSWORD != '' && secrets.APPLE_TEAM_ID != '' }}
        run: npm run package:mac
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_API_KEY: /tmp/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER: ${{ secrets.APPLE_API_ISSUER }}
          CSC_LINK: ${{ secrets.CSC_LINK }}
          CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}

      # Fallback: Build without signing if secrets not present
      - name: Package for macOS (unsigned)
        if: ${{ secrets.APPLE_ID == '' || secrets.APPLE_APP_SPECIFIC_PASSWORD == '' || secrets.APPLE_TEAM_ID == '' }}
        run: npm run package:mac
        env:
          SKIP_NOTARIZE: 'true'

      # Upload to GitHub Release if this was triggered by a release
      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*.dmg
            release/*.pkg
            release/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload as workflow artifacts for manual runs
      - name: Upload Build Artifacts
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: macos-builds
          path: |
            release/*.dmg
            release/*.pkg
            release/*.zip
          retention-days: 30
