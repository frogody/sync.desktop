name: Build & Package macOS

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build-macos:
    name: Build macOS artifacts
    runs-on: macos-latest
    env:
      NODE_ENV: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build app
        run: npm run build

      # OPTIONAL: Import macOS signing identity (p12) into a temporary keychain if provided
      # Secrets required for this step:
      #   - APPLE_P12_BASE64: base64 single-line of exported .p12 (cert + private key)
      #   - P12_PASSWORD: password used when exporting the .p12
      #   - KEYCHAIN_PASSWORD: password for temporary keychain created in CI
      # This step is gated and will not run unless APPLE_P12_BASE64 exists in repo secrets.
      - name: Import macOS signing identity into temporary keychain (optional)
        if: secrets.APPLE_P12_BASE64 != ''
        run: |
          set -euo pipefail
          TMP_P12="/tmp/codesign.p12"
          echo "Reconstructing .p12 for temporary import..."
          # Recreate .p12 from secret (do NOT print secrets)
          echo "$APPLE_P12_BASE64" | base64 --decode > "$TMP_P12"
          chmod 600 "$TMP_P12"

          # create temporary keychain and import
          KEYCHAIN="$HOME/Library/Keychains/build.keychain-db"
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security import "$TMP_P12" -k "$KEYCHAIN" -P "$P12_PASSWORD" -T /usr/bin/codesign -T /usr/bin/productbuild -T /usr/bin/security
          # add keychain to the search list and set it as default for this job
          security list-keychains -s "$KEYCHAIN"
          security default-keychain -s "$KEYCHAIN"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          # Allow codesign/productbuild to access the private key without a prompt
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN"

          echo "Imported .p12 into temporary keychain (no secrets printed)."
        env:
          APPLE_P12_BASE64: ${{ secrets.APPLE_P12_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}

      # OPTIONAL: Reconstruct App Store Connect API key (.p8) for notarization
      # Secrets required for this step:
      #   - APPLE_API_KEY_PRIVATE_BASE64: base64 single-line of .p8 file
      #   - APPLE_API_KEY_ID: key ID (e.g., ABC123XYZ)
      #   - APPLE_API_KEY_ISSUER_ID: issuer ID (UUID)
      # This step is gated and will not run unless APPLE_API_KEY_PRIVATE_BASE64 exists.
      - name: Reconstruct App Store Connect API key for notarization (optional)
        if: secrets.APPLE_API_KEY_PRIVATE_BASE64 != ''
        run: |
          set -euo pipefail
          echo "Reconstructing App Store Connect API key..."
          API_KEY_PATH="/tmp/AuthKey_${APPLE_API_KEY_ID}.p8"
          echo "$APPLE_API_KEY_PRIVATE_BASE64" | base64 --decode > "$API_KEY_PATH"
          chmod 600 "$API_KEY_PATH"
          echo "APPLE_API_KEY_PATH=$API_KEY_PATH" >> $GITHUB_ENV
          echo "App Store Connect API key reconstructed at $API_KEY_PATH"
        env:
          APPLE_API_KEY_PRIVATE_BASE64: ${{ secrets.APPLE_API_KEY_PRIVATE_BASE64 }}
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}

      # Package the app (electron-builder will codesign if identity is available)
      - name: Package macOS app
        run: npm run package:mac
        env:
          MAC_SIGNING_IDENTITY: ${{ secrets.MAC_SIGNING_IDENTITY }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          DEBUG_CODESIGN: ${{ secrets.DEBUG_CODESIGN }}

      # OPTIONAL: Notarize the .pkg and .dmg if API key is present
      # Requires scripts/notarize.js to read APPLE_API_KEY_PATH from env
      - name: Notarize macOS artifacts (optional)
        if: secrets.APPLE_API_KEY_PRIVATE_BASE64 != ''
        run: node scripts/notarize.js
        env:
          APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          APPLE_API_KEY_ISSUER_ID: ${{ secrets.APPLE_API_KEY_ISSUER_ID }}

      # Upload artifacts for manual workflow runs
      - name: Upload macOS artifacts (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: mac-artifacts-${{ github.sha }}
          path: release/*.{dmg,pkg,zip}

      # Upload .dmg to release
      - name: Upload .dmg to Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: release/*.dmg
          asset_name: SYNC.Desktop-${{ github.event.release.tag_name }}.dmg
          asset_content_type: application/x-apple-diskimage

      # Upload .pkg to release
      - name: Upload .pkg to Release
        if: github.event_name == 'release'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: release/*.pkg
          asset_name: SYNC.Desktop-${{ github.event.release.tag_name }}.pkg
          asset_content_type: application/x-newton-compatible-pkg
